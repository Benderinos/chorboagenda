name: Develop

on:
  # Triggers the workflow on every push to develop
  push:
    branches:
      - develop

  workflow_dispatch:

jobs:
  build_and_publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the code
        uses: actions/checkout@v2

      - uses: actions/cache@v2
          with:
            path: |
              ~/.gradle/caches
              ~/.gradle/wrapper
          key: ${{ runner.os }}-${{ hashFiles('**/*.gradle*') }}-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}-${{ hashFiles('**/buildSrc/**/*.kt') }}

      - name: Set up JDK 1.8
          uses: actions/setup-java@v1
          with:
            java-version: 1.8

      - name: Build the app
          run: ./gradlew assembleDebug

test:
  runs-on: macos-latest
  needs: build
  strategy:
    matrix:
      api-level: [ 21, 23, 29 ]
      target: [ default ]

      steps:
        - name: Checkout the code
          uses: actions/checkout@v2

            - uses: actions/cache@v2
                with:
                path: |
                  ~/.gradle/caches
                  ~/.gradle/wrapper
                key: ${{ runner.os }}-${{ hashFiles('**/*.gradle*') }}-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}-${{ hashFiles('**/buildSrc/**/*.kt') }}

            - name: Copy  gradle properties file
              run: mkdir -p ~/.gradle ; cp .github/ci-gradle.properties ~/.gradle/gradle.properties

            - name: Set up JDK 1.8
              uses: actions/setup-java@v1
              with:
                java-version: 1.8

            - name: Run detekt
              run: ./gradlew detektCheck

            - name: Run unit tests
                run: ./gradlew test --stacktrace

            - name: Upload Reports
                uses: actions/upload-artifact@v2
                with:
                  name: Test-Reports
                  path: app/build/reports
                if: always()
